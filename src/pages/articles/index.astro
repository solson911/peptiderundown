---
import Base from '../../layouts/Base.astro';
import PageSidebar from '../../components/PageSidebar.astro';

const mdPosts = await Astro.glob('./*.md');
const astroPosts = (await Astro.glob('./*.astro')).filter(p => p.frontmatter && p.url !== '/articles/');
const allPosts = [...mdPosts, ...astroPosts];

// Dedupe by URL (prevents double listings if two files resolve to the same route)
const dedupedByUrl = Object.values(allPosts.reduce((acc, p) => {
  const key = p.url;
  const prev = acc[key];
  if (!prev) {
    acc[key] = p;
    return acc;
  }
  const prevDate = new Date(prev.frontmatter?.date || 0).getTime();
  const nextDate = new Date(p.frontmatter?.date || 0).getTime();
  if (nextDate >= prevDate) acc[key] = p;
  return acc;
}, /** @type {Record<string, any>} */ ({})));

const posts = dedupedByUrl.sort((a, b) => new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime());

const categories = [...new Set(posts.map(p => p.frontmatter.category).filter(Boolean))].sort();
---
<Base title="All Guides">
  <!-- Header -->
  <section class="bg-gradient-to-br from-surface-dark via-primary-dark to-surface-dark py-16">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 text-center">
      <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-3">Peptide Guides</h1>
      <p class="text-lg text-gray-300 max-w-2xl mx-auto">In-depth, research-backed articles on peptides, dosing, safety, and more.</p>
    </div>
  </section>

  <!-- Category Chips + Quick Search -->
  <section class="bg-white border-b border-gray-100 sticky top-16 z-10">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 space-y-3">
      <div class="flex items-center gap-2 overflow-x-auto pb-1" id="filter-bar">
        <span class="text-xs font-bold text-text-muted uppercase tracking-wide shrink-0 mr-1">Filter:</span>
        <button data-category="All" class="filter-btn px-3 py-1 text-xs font-semibold rounded-full bg-primary text-white shrink-0 cursor-pointer">All</button>
        {categories.map(cat => (
          <button data-category={cat} class="filter-btn px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-text-muted hover:bg-primary/10 hover:text-primary transition-colors shrink-0 cursor-pointer">
            {cat}
          </button>
        ))}
      </div>

      <div class="flex items-center gap-3">
        <div class="relative flex-1">
          <input id="article-search" type="search" placeholder="Search guides (title + description)â€¦" class="w-full rounded-xl border border-gray-200 bg-white px-4 py-2 text-sm text-text shadow-sm focus:outline-none focus:ring-2 focus:ring-primary/30" />
          <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-text-muted">Ctrl+K</span>
        </div>
        <button id="clear-search" class="hidden px-3 py-2 text-sm font-semibold rounded-xl bg-gray-100 text-text-muted hover:bg-primary/10 hover:text-primary transition-colors">Clear</button>
      </div>
    </div>
  </section>

  <!-- Articles Grid + Sidebar -->
  <section class="bg-pattern bg-surface py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="md:flex md:gap-8 items-start">
        <!-- Articles Grid -->
        <div class="md:flex-1 min-w-0">
          <div class="grid sm:grid-cols-2 gap-6" id="articles-grid">
            {posts.map((post) => (
              <a href={post.url}
                 data-cat={post.frontmatter.category}
                 data-title={post.frontmatter.title}
                 data-desc={post.frontmatter.description}
                 class="article-card group block bg-white rounded-2xl overflow-hidden card-glow transition-all hover:-translate-y-1 border border-gray-100">
                {post.frontmatter.image && (
                  <div class="h-44 overflow-hidden">
                    <img src={post.frontmatter.image} alt={post.frontmatter.title} class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" loading="lazy" />
                  </div>
                )}
                <div class="p-5">
                  {post.frontmatter.category && (
                    <span class="inline-block px-2.5 py-0.5 text-xs font-bold text-primary bg-primary/10 rounded-full mb-2">
                      {post.frontmatter.category}
                    </span>
                  )}
                  <h2 class="text-lg font-bold text-text group-hover:text-primary transition-colors mb-2 line-clamp-2">
                    {post.frontmatter.title}
                  </h2>
                  {post.frontmatter.description && (
                    <p class="text-text-muted text-sm leading-relaxed line-clamp-2">{post.frontmatter.description}</p>
                  )}
                </div>
              </a>
            ))}
          </div>
        </div>
        <!-- Sidebar -->
        <PageSidebar />
      </div>
    </div>
  </section>

  <script>
    let activeCategory = 'All';

    const searchInput = document.getElementById('article-search');
    const clearBtn = document.getElementById('clear-search');

    function applyFilters() {
      const q = (searchInput?.value || '').trim().toLowerCase();
      const hasQuery = q.length > 0;
      if (clearBtn) clearBtn.classList.toggle('hidden', !hasQuery);

      document.querySelectorAll('.article-card').forEach(card => {
        const cat = card.getAttribute('data-cat') || '';
        const title = (card.getAttribute('data-title') || '').toLowerCase();
        const desc = (card.getAttribute('data-desc') || '').toLowerCase();

        const catOk = (activeCategory === 'All' || cat === activeCategory);
        const qOk = (!hasQuery || title.includes(q) || desc.includes(q));

        card.style.display = (catOk && qOk) ? '' : 'none';
      });
    }

    // Category chips
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        activeCategory = btn.getAttribute('data-category') || 'All';
        document.querySelectorAll('.filter-btn').forEach(b => {
          b.className = 'filter-btn px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-text-muted hover:bg-primary/10 hover:text-primary transition-colors shrink-0 cursor-pointer';
        });
        btn.className = 'filter-btn px-3 py-1 text-xs font-semibold rounded-full bg-primary text-white shrink-0 cursor-pointer';
        applyFilters();
      });
    });

    // Search
    if (searchInput) {
      searchInput.addEventListener('input', applyFilters);
      // Nice UX: focus the search box when user hits Ctrl+K
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
          e.preventDefault();
          searchInput.focus();
        }
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        if (searchInput) searchInput.value = '';
        applyFilters();
        searchInput?.focus();
      });
    }

    applyFilters();
  </script>
</Base>
